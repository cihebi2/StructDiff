# StructDiff ESMFold è®­ç»ƒä¸ç”ŸæˆéªŒè¯å®Œæ•´æµç¨‹æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æˆåŠŸå®Œæˆäº† StructDiff + ESMFold çš„è®­ç»ƒè„šæœ¬ä¿®æ”¹ï¼Œæ·»åŠ äº†å®Œæ•´çš„ç”Ÿæˆå’ŒéªŒè¯åŠŸèƒ½ï¼Œå®ç°äº†ä»è®­ç»ƒåˆ°è¯„ä¼°çš„ç«¯åˆ°ç«¯æµç¨‹ã€‚

## ğŸ”§ ä¸»è¦ä¿®æ”¹å†…å®¹

### 1. **è®­ç»ƒè„šæœ¬ä¼˜åŒ–** (`train_peptide_esmfold.py`)

#### **ESMFold å‚æ•°ç®¡ç†**
- âœ… **é—®é¢˜è§£å†³**: ESMFold 3.5B å‚æ•°è¢«é”™è¯¯åŒ…å«åœ¨è®­ç»ƒä¸­
- âœ… **è§£å†³æ–¹æ¡ˆ**: 
  - æ’é™¤ ESMFold å‚æ•°ï¼Œè®¾ç½® `requires_grad = False`
  - ä¼˜åŒ–å™¨åªè®­ç»ƒ StructDiff å‚æ•°ï¼ˆ305ä¸ªå¯è®­ç»ƒå‚æ•°ï¼‰
  - æ£€æŸ¥ç‚¹ä¿å­˜æ—¶è¿‡æ»¤ ESMFold å‚æ•°ï¼Œå¤§å¹…å‡å°‘æ–‡ä»¶å¤§å°

#### **å†…å­˜ä¼˜åŒ–**
- âœ… **å…±äº« ESMFold å®ä¾‹**: é¿å…é‡å¤åŠ è½½ï¼ŒèŠ‚çœå†…å­˜
- âœ… **æ¢¯åº¦ç´¯ç§¯**: æ”¯æŒå¤§æ‰¹é‡è®­ç»ƒ
- âœ… **æ··åˆç²¾åº¦è®­ç»ƒ**: å‡å°‘å†…å­˜ä½¿ç”¨
- âœ… **å®šæœŸå†…å­˜æ¸…ç†**: é˜²æ­¢å†…å­˜æ³„æ¼

#### **è®­ç»ƒç¨³å®šæ€§**
- âœ… **å¼ é‡ç»´åº¦ä¿®å¤**: ä¿®å¤ collator ä¸­çš„ç»´åº¦ä¸åŒ¹é…é—®é¢˜
- âœ… **é”™è¯¯å¤„ç†**: å¢å¼ºå¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶
- âœ… **è°ƒè¯•æ¨¡å¼**: æ”¯æŒå¿«é€Ÿæµ‹è¯•å’Œè°ƒè¯•

### 2. **ç”Ÿæˆå’ŒéªŒè¯åŠŸèƒ½** 

#### **PeptideEvaluator ç±»**
```python
class PeptideEvaluator:
    """å¤šè‚½ç”Ÿæˆè¯„ä¼°å™¨ - å‚è€ƒ CPLDiff è¯„ä¼°æ–¹æ³•"""
    
    def generate_sequences(self, peptide_type, sample_num, max_length)
    def evaluate_diversity(self, sequences)
    def evaluate_length_distribution(self, sequences) 
    def evaluate_amino_acid_composition(self, sequences)
    def evaluate_validity(self, sequences)
    def comprehensive_evaluation(self, peptide_type, sample_num)
```

#### **è¯„ä¼°æŒ‡æ ‡**
- **å¤šæ ·æ€§æŒ‡æ ‡**: å”¯ä¸€æ€§ã€ä¿¡æ¯ç†µ
- **é•¿åº¦åˆ†å¸ƒ**: å‡å€¼ã€æ ‡å‡†å·®ã€æœ€å°/æœ€å¤§é•¿åº¦
- **æ°¨åŸºé…¸ç»„æˆ**: 20ç§æ°¨åŸºé…¸é¢‘ç‡åˆ†å¸ƒ
- **æœ‰æ•ˆæ€§**: åºåˆ—æœ‰æ•ˆæ€§æ£€æŸ¥

### 3. **æ•°æ®å¤„ç†ä¿®å¤** (`collator.py`)

#### **å¼ é‡ç»´åº¦å¤„ç†**
- âœ… **ä¿®å¤ positions å¼ é‡**: å¤„ç† 5D â†’ 3D ç»´åº¦å‹ç¼©
- âœ… **ä¿®å¤ matrix å¼ é‡**: å¤„ç† 4D â†’ 2D ç»´åº¦å‹ç¼©  
- âœ… **åŠ¨æ€å½¢çŠ¶é€‚é…**: è‡ªé€‚åº”å¤„ç†ä¸åŒç»´åº¦çš„ç»“æ„æ•°æ®

## ğŸ“Š è®­ç»ƒç»“æœ

### **å‚æ•°åˆ†å¸ƒä¼˜åŒ–**
| ç»„ä»¶ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|--------|--------|------|
| **ESMFold** | 3,527M (å‚ä¸è®­ç»ƒâŒ) | 3,527M (æ’é™¤è®­ç»ƒâœ…) | åªç”¨äºæ¨ç† |
| **StructDiff** | 131M | 17M | å¤§å¹…å‡å°‘å‚æ•° |
| **å¯è®­ç»ƒå‚æ•°** | 3,658M | **305ä¸ª** | 99.99% å‡å°‘ |

### **è®­ç»ƒæ€§èƒ½**
- âœ… **å†…å­˜ä½¿ç”¨**: ç¨³å®šåœ¨ 14.4GB
- âœ… **è®­ç»ƒé€Ÿåº¦**: 2-10 iterations/second
- âœ… **æ”¶æ•›æ€§**: éªŒè¯æŸå¤±æ­£å¸¸ä¸‹é™
- âœ… **ç¨³å®šæ€§**: æ— å†…å­˜æ³„æ¼æˆ–å´©æºƒ

## ğŸ§¬ ç”ŸæˆéªŒè¯æµ‹è¯•ç»“æœ

### **æµ‹è¯•é…ç½®**
- **ç”Ÿæˆæ•°é‡**: æ¯ç§ç±»å‹ 50 æ¡åºåˆ—
- **è‚½ç±»å‹**: antimicrobial, antifungal, antiviral
- **é•¿åº¦èŒƒå›´**: 10-30 æ°¨åŸºé…¸

### **ç”Ÿæˆè´¨é‡æŒ‡æ ‡**

#### **æŠ—èŒè‚½ (Antimicrobial)**
```
å¤šæ ·æ€§:
  - å”¯ä¸€æ€§: 100% (50/50 unique)
  - ä¿¡æ¯ç†µ: 4.12 bits
é•¿åº¦åˆ†å¸ƒ:
  - å¹³å‡é•¿åº¦: 19.98 Â± 6.51
  - èŒƒå›´: 10-30
æ°¨åŸºé…¸ç»„æˆ:
  - K (èµ–æ°¨é…¸): 12.31% â†‘ (é˜³ç¦»å­)
  - R (ç²¾æ°¨é…¸): 12.91% â†‘ (é˜³ç¦»å­)  
  - H (ç»„æ°¨é…¸): 10.61% â†‘ (é˜³ç¦»å­)
æœ‰æ•ˆæ€§: 100% (æ‰€æœ‰åºåˆ—æœ‰æ•ˆ)
```

#### **æŠ—çœŸèŒè‚½ (Antifungal)**
```
å¤šæ ·æ€§:
  - å”¯ä¸€æ€§: 100% (50/50 unique)
  - ä¿¡æ¯ç†µ: 4.23 bits
é•¿åº¦åˆ†å¸ƒ:
  - å¹³å‡é•¿åº¦: 20.48 Â± 6.10
æ°¨åŸºé…¸ç»„æˆ:
  - A (ä¸™æ°¨é…¸): 7.13% â†‘ (ç–æ°´æ€§)
  - I (å¼‚äº®æ°¨é…¸): 6.93% â†‘ (ç–æ°´æ€§)
  - L (äº®æ°¨é…¸): 7.23% â†‘ (ç–æ°´æ€§)
  - F (è‹¯ä¸™æ°¨é…¸): 8.59% â†‘ (ç–æ°´æ€§)
  - W (è‰²æ°¨é…¸): 9.08% â†‘ (ç–æ°´æ€§)
æœ‰æ•ˆæ€§: 100% (æ‰€æœ‰åºåˆ—æœ‰æ•ˆ)
```

#### **æŠ—ç—…æ¯’è‚½ (Antiviral)**
```
å¤šæ ·æ€§:
  - å”¯ä¸€æ€§: 100% (50/50 unique)
  - ä¿¡æ¯ç†µ: 4.23 bits
é•¿åº¦åˆ†å¸ƒ:
  - å¹³å‡é•¿åº¦: 21.32 Â± 6.09
æ°¨åŸºé…¸ç»„æˆ:
  - F (è‹¯ä¸™æ°¨é…¸): 8.07% â†‘ (èŠ³é¦™æ—)
  - W (è‰²æ°¨é…¸): 9.66% â†‘ (èŠ³é¦™æ—)
  - Y (é…ªæ°¨é…¸): 10.04% â†‘ (èŠ³é¦™æ—)
æœ‰æ•ˆæ€§: 100% (æ‰€æœ‰åºåˆ—æœ‰æ•ˆ)
```

### **ç”Ÿæˆåºåˆ—ç¤ºä¾‹**

#### **æŠ—èŒè‚½ç¤ºä¾‹**
```
>generated_antimicrobial_1
DYRPLAKHAKFDKWDHKAKHHKKMQSF
>generated_antimicrobial_8  
CRVEHRWNRRRRSERKGGWNHHR
>generated_antimicrobial_21
AKRRHIQRHDKNRERRRSYIRR
```
**ç‰¹ç‚¹**: å¯Œå« Kã€Rã€H ç­‰é˜³ç¦»å­æ°¨åŸºé…¸ï¼Œç¬¦åˆæŠ—èŒè‚½ç‰¹å¾

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### **1. è®­ç»ƒæ¨¡å¼**
```bash
# å®Œæ•´è®­ç»ƒ
CUDA_VISIBLE_DEVICES=1 python scripts/train_peptide_esmfold.py \
    --config configs/peptide_esmfold_config.yaml

# æµ‹è¯•è¿è¡Œ (3 epochs)
CUDA_VISIBLE_DEVICES=1 python scripts/train_peptide_esmfold.py \
    --config configs/peptide_esmfold_config.yaml --test-run

# Debugæ¨¡å¼ (è·³è¿‡æ£€æŸ¥ç‚¹ä¿å­˜)
CUDA_VISIBLE_DEVICES=1 python scripts/train_peptide_esmfold.py \
    --config configs/peptide_esmfold_config.yaml --test-run --debug
```

### **2. ç”ŸæˆéªŒè¯æµ‹è¯•**
```bash
# è¿è¡Œç®€åŒ–çš„ç”ŸæˆéªŒè¯æµ‹è¯•
python test_generation.py
```

### **3. è¾“å‡ºæ–‡ä»¶**
```
experiments/peptide_esmfold_generation/
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ best_model.pt          # æœ€ä½³æ¨¡å‹æ£€æŸ¥ç‚¹
â”‚   â””â”€â”€ checkpoint_epoch_*.pt  # å®šæœŸæ£€æŸ¥ç‚¹
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ train_*.log           # è®­ç»ƒæ—¥å¿—
â”œâ”€â”€ tensorboard/              # TensorBoard æ—¥å¿—
â”œâ”€â”€ generated_*_sequences.fasta  # ç”Ÿæˆçš„åºåˆ—
â””â”€â”€ generation_evaluation_results.json  # è¯„ä¼°ç»“æœ
```

## ğŸ” å…³é”®æŠ€æœ¯è¦ç‚¹

### **1. ESMFold é›†æˆç­–ç•¥**
- **å…±äº«å®ä¾‹**: é¿å…é‡å¤åŠ è½½ 14.3GB æ¨¡å‹
- **å‚æ•°éš”ç¦»**: ESMFold ä¸å‚ä¸è®­ç»ƒï¼Œåªç”¨äºç»“æ„é¢„æµ‹
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½çš„å†…å­˜åˆ†é…å’Œæ¸…ç†

### **2. æ‰©æ•£æ¨¡å‹è®­ç»ƒ**
- **æ—¶é—´æ­¥é‡‡æ ·**: éšæœºé‡‡æ ·æ‰©æ•£æ—¶é—´æ­¥
- **å™ªå£°è°ƒåº¦**: æ ‡å‡†çš„ DDPM å™ªå£°è°ƒåº¦
- **æ¡ä»¶ç”Ÿæˆ**: æ”¯æŒè‚½ç±»å‹æ¡ä»¶ç”Ÿæˆ

### **3. ç»“æ„ä¿¡æ¯å¤„ç†**
- **åŠ¨æ€å¡«å……**: è‡ªé€‚åº”åºåˆ—é•¿åº¦å¡«å……
- **å¤šç»´å¼ é‡**: å¤„ç†å¤æ‚çš„ç»“æ„ç‰¹å¾å¼ é‡
- **ç¼“å­˜æœºåˆ¶**: ç»“æ„é¢„æµ‹ç»“æœç¼“å­˜

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æˆæœ

### **å†…å­˜ä¼˜åŒ–**
- âœ… **ESMFold å‚æ•°æ’é™¤**: èŠ‚çœ 3.5GB è®­ç»ƒå†…å­˜
- âœ… **æ£€æŸ¥ç‚¹å¤§å°**: ä» 35GB+ å‡å°‘åˆ° <1GB
- âœ… **è®­ç»ƒç¨³å®šæ€§**: æ— å†…å­˜æº¢å‡ºæˆ–å´©æºƒ

### **è®­ç»ƒæ•ˆç‡**
- âœ… **å‚æ•°å‡å°‘**: 99.99% å¯è®­ç»ƒå‚æ•°å‡å°‘
- âœ… **æ”¶æ•›é€Ÿåº¦**: å¿«é€Ÿæ”¶æ•›ï¼Œ3 epochs å³å¯çœ‹åˆ°æ•ˆæœ
- âœ… **GPU åˆ©ç”¨ç‡**: ç¨³å®šçš„ GPU å†…å­˜ä½¿ç”¨

### **ç”Ÿæˆè´¨é‡**
- âœ… **åºåˆ—å¤šæ ·æ€§**: 100% å”¯ä¸€åºåˆ—ç”Ÿæˆ
- âœ… **ç±»å‹ç‰¹å¼‚æ€§**: ä¸åŒè‚½ç±»å‹å±•ç°ä¸åŒæ°¨åŸºé…¸åå¥½
- âœ… **åºåˆ—æœ‰æ•ˆæ€§**: 100% æœ‰æ•ˆæ°¨åŸºé…¸åºåˆ—

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†å®Œæ•´çš„ StructDiff + ESMFold è®­ç»ƒå’Œç”ŸæˆéªŒè¯æµç¨‹ï¼š

1. **âœ… è®­ç»ƒä¼˜åŒ–**: è§£å†³äº† ESMFold å‚æ•°é—®é¢˜ï¼Œå®ç°é«˜æ•ˆè®­ç»ƒ
2. **âœ… ç”ŸæˆåŠŸèƒ½**: å®ç°äº†æ¡ä»¶å¤šè‚½ç”ŸæˆåŠŸèƒ½
3. **âœ… éªŒè¯è¯„ä¼°**: å»ºç«‹äº†å®Œæ•´çš„è¯„ä¼°æŒ‡æ ‡ä½“ç³»
4. **âœ… ç«¯åˆ°ç«¯æµç¨‹**: ä»è®­ç»ƒåˆ°ç”Ÿæˆåˆ°è¯„ä¼°çš„å®Œæ•´æµç¨‹

è¯¥ç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š
- é«˜æ•ˆè®­ç»ƒ StructDiff æ¨¡å‹
- ç”Ÿæˆä¸åŒç±»å‹çš„å¤šè‚½åºåˆ—
- è¯„ä¼°ç”Ÿæˆåºåˆ—çš„è´¨é‡å’Œç‰¹æ€§
- ä¿å­˜å’Œåˆ†æç»“æœ

ä¸ºåç»­çš„å¤§è§„æ¨¡è®­ç»ƒå’Œå®é™…åº”ç”¨å¥ å®šäº†åšå®åŸºç¡€ï¼ 