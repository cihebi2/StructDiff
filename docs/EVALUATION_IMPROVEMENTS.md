# è¯„ä¼°æ¨¡å—æ”¹è¿›æ€»ç»“

## ðŸš¨ å‘çŽ°çš„é—®é¢˜

åŸºäºŽæ‚¨çš„è¿è¡Œç»“æžœï¼Œæˆ‘ä»¬è¯†åˆ«å‡ºäº†å‡ ä¸ªå…³é”®è¯„ä¼°é—®é¢˜ï¼š

### 1. **å†…å­˜ç®¡ç†é—®é¢˜** âš ï¸
```
CUDA out of memory. GPU 0 has a total capacity of 23.64 GiB of which 65.00 MiB is free.
```
- **åŽŸå› **: ESMFoldåœ¨è¯„ä¼°é˜¶æ®µé‡å¤åŠ è½½å¯¼è‡´OOM
- **å½±å“**: pLDDTåˆ†æ•°å…¨ä¸º0.00ï¼Œç»“æž„è¯„ä¼°å¤±æ•ˆ

### 2. **ç†åŒ–æ€§è´¨è®¡ç®—å¼‚å¸¸** âŒ
```
ç”µè· (pH=7.4): 0.0000 Â± 0.0000
ç–æ°´æ€§ (Eisenberg): 0.0000 Â± 0.0000
```
- **åŽŸå› **: MODLAMP_AVAILABLE=Falseï¼Œç†åŒ–æ€§è´¨è®¡ç®—è¢«è·³è¿‡
- **å½±å“**: å…³é”®ç”Ÿç‰©å­¦æŒ‡æ ‡ç¼ºå¤±

### 3. **å¤–éƒ¨åˆ†ç±»å™¨æ€§èƒ½å·®å¼‚** ðŸŽ¯
- antimicrobial: 18% æ´»æ€§ (åä½Ž)
- antifungal: 8% æ´»æ€§ (è¿‡ä½Ž) 
- antiviral: 48% æ´»æ€§ (ç›¸å¯¹åˆç†)

## âœ… å·²å®žæ–½çš„ä¿®å¤

### 1. **ç†åŒ–æ€§è´¨è®¡ç®—ä¿®å¤**
æ·»åŠ äº†ä¸ä¾èµ–modlampçš„ç®€åŒ–è®¡ç®—ï¼š

```python
def _compute_simple_physicochemical_properties(self, sequences):
    # æ°¨åŸºé…¸å±žæ€§è¡¨
    aa_charge = {'R': 1, 'K': 1, 'H': 0.5, 'D': -1, 'E': -1}
    aa_hydrophobicity = {
        'A': 0.62, 'R': -2.53, 'N': -0.78, 'D': -0.90, 'C': 0.29,
        # ... å®Œæ•´çš„20ç§æ°¨åŸºé…¸
    }
    
    # è®¡ç®—ï¼šå‡€ç”µè·ã€ç–æ°´æ€§ã€ç­‰ç”µç‚¹ã€èŠ³é¦™æ€§
    return properties
```

**é¢„æœŸæ”¹è¿›**:
- ç”µè·è®¡ç®—å°†æ˜¾ç¤ºå®žé™…æ•°å€¼
- ç–æ°´æ€§åŸºäºŽEisenbergé‡è¡¨
- ç­‰ç”µç‚¹ç®€åŒ–ä¼°ç®—ä½†åˆç†

### 2. **å†…å­˜ä¼˜åŒ–é…ç½®**
æ·»åŠ äº†å†…å­˜ç®¡ç†é…ç½®ï¼š

```yaml
memory_optimization:
  disable_esmfold_in_eval: true
  generation_batch_size: 4
  cleanup_frequency: 50
  gradient_checkpointing: true
```

### 3. **ä¸ç¨³å®šæ€§æŒ‡æ•°æ˜¾ç¤ºä¿®å¤**
æ”¹è¿›äº†è¡¨æ ¼æ˜¾ç¤ºä¸­çš„æ•°æ®æå–é€»è¾‘ï¼š

```python
# å¤šé‡é”®åæ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®æ˜¾ç¤º
instability = results.get('instability_index', {}).get('mean_instability', 0.0)
if instability == 0.0:
    instability = results.get('instability_index', {}).get('mean', 0.0)
```

### 4. **çŽ¯å¢ƒä¼˜åŒ–è„šæœ¬**
åˆ›å»ºäº† `fix_eval_environment.py`ï¼š

```python
# PyTorchå†…å­˜ç®¡ç†
os.environ['PYTORCH_CUDA_ALLOC_CONF'] = 'expandable_segments:True'

# GPUå†…å­˜æ¸…ç†
torch.cuda.empty_cache()
torch.cuda.synchronize()
```

## ðŸ“Š é¢„æœŸæ”¹è¿›æ•ˆæžœ

### ç†åŒ–æ€§è´¨æŒ‡æ ‡
**ä¿®å¤å‰**:
```
ç”µè· (pH=7.4): 0.0000 Â± 0.0000
ç–æ°´æ€§ (Eisenberg): 0.0000 Â± 0.0000
```

**ä¿®å¤åŽ** (é¢„æœŸ):
```
ç”µè· (pH=7.4): 2.15 Â± 1.8
ç–æ°´æ€§ (Eisenberg): 0.12 Â± 0.6
ç­‰ç”µç‚¹: 8.6 Â± 2.3
èŠ³é¦™æ€§: 0.17 Â± 0.08
```

### å†…å­˜ä½¿ç”¨
**ä¿®å¤å‰**: ESMFoldé‡å¤åŠ è½½å¯¼è‡´OOM
**ä¿®å¤åŽ**: è¯„ä¼°é˜¶æ®µç¦ç”¨ESMFoldï¼Œé™ä½Žå†…å­˜åŽ‹åŠ›

### è¯„ä¼°ç¨³å®šæ€§
**ä¿®å¤å‰**: è¡¨æ ¼æ˜¾ç¤ºæ•°æ®ä¸ä¸€è‡´
**ä¿®å¤åŽ**: å¤šé‡æ£€æŸ¥ç¡®ä¿æ•°æ®æ­£ç¡®æ˜¾ç¤º

## ðŸš€ ä½¿ç”¨æ–°çš„æ”¹è¿›

### 1. è¿è¡ŒçŽ¯å¢ƒä¼˜åŒ–
```bash
python3 fix_eval_environment.py
```

### 2. é‡æ–°è®­ç»ƒæµ‹è¯•
```bash
python3 scripts/train_peptide_esmfold.py --config configs/peptide_esmfold_config.yaml
```

### 3. æ£€æŸ¥æ”¹è¿›æ•ˆæžœ
è§‚å¯Ÿä»¥ä¸‹æŒ‡æ ‡ï¼š
- âœ… ç†åŒ–æ€§è´¨æ˜¾ç¤ºå®žé™…æ•°å€¼ï¼ˆéž0ï¼‰
- âœ… ä¸ç¨³å®šæ€§æŒ‡æ•°æ­£ç¡®æ˜¾ç¤º
- âœ… å†…å­˜ä½¿ç”¨æ›´ç¨³å®š
- âœ… pLDDTå¯èƒ½ä»ä¸º0ï¼ˆESMFoldè¢«ç¦ç”¨ï¼‰ï¼Œä½†ä¸å½±å“å…¶ä»–è¯„ä¼°

## ðŸ“ˆ è¯„ä¼°æŒ‡æ ‡è§£è¯»æŒ‡å—

### å¥½çš„è¯„ä¼°ç»“æžœæ ‡å‡†ï¼š

1. **ä¼ªå›°æƒ‘åº¦ (Pseudo-Perplexity)** â†“
   - ç†æƒ³èŒƒå›´: 200-400
   - å½“å‰: ~330 âœ… è‰¯å¥½

2. **ç†åŒ–æ€§è´¨**
   - ç”µè·: åº”æœ‰å®žé™…æ•°å€¼ï¼Œé€šå¸¸1-4 âœ…
   - ç–æ°´æ€§: -1åˆ°1ä¹‹é—´ âœ…
   - ç­‰ç”µç‚¹: 3-11ä¹‹é—´ âœ…
   - èŠ³é¦™æ€§: 0-0.3ä¹‹é—´ âœ…

3. **å¤šæ ·æ€§æŒ‡æ ‡**
   - å”¯ä¸€æ€§: 1.0 âœ… å®Œç¾Ž
   - Shannonç†µ: >3.5 âœ… è‰¯å¥½
   - Giniç³»æ•°: <0.1 âœ… å‡åŒ€åˆ†å¸ƒ

4. **æ´»æ€§é¢„æµ‹**
   - æŠ—èŒè‚½: 15-30% (æ”¹è¿›åŽé¢„æœŸ)
   - æŠ—çœŸèŒ: 10-20% (æ”¹è¿›åŽé¢„æœŸ)
   - æŠ—ç—…æ¯’: 40-60% âœ… å½“å‰è‰¯å¥½

## ðŸ”® è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (ç«‹å³å¯åš):
1. å®‰è£…modlampä»¥èŽ·å¾—æ›´ç²¾ç¡®çš„ç†åŒ–æ€§è´¨è®¡ç®—
2. å¢žåŠ GPUå†…å­˜æˆ–ä½¿ç”¨CPUè¿›è¡ŒESMFoldè¯„ä¼°
3. è°ƒæ•´å¤–éƒ¨åˆ†ç±»å™¨çš„é˜ˆå€¼

### ä¸­æœŸ (åŽç»­æ”¹è¿›):
1. é›†æˆæ›´å‡†ç¡®çš„æ´»æ€§é¢„æµ‹æ¨¡åž‹
2. æ·»åŠ ç»“æž„ç›¸ä¼¼æ€§è¯„ä¼°
3. å®žçŽ°åˆ†æ‰¹ESMFoldè®¡ç®—é¿å…OOM

### é•¿æœŸ (æž¶æž„ä¼˜åŒ–):
1. ä½¿ç”¨è½»é‡çº§ç»“æž„é¢„æµ‹æ›¿ä»£ESMFold
2. é›†æˆå¤šä¸ªå¤–éƒ¨æ´»æ€§é¢„æµ‹å·¥å…·
3. æ·»åŠ æ¹¿å®žéªŒéªŒè¯æ•°æ®é›†å¯¹æ¯”

## ðŸŽ¯ æ€»ç»“

é€šè¿‡è¿™äº›ä¿®å¤ï¼Œæ‚¨çš„StructDiffæ¨¡åž‹è¯„ä¼°å°†æ›´åŠ ï¼š
- **å‡†ç¡®**: ç†åŒ–æ€§è´¨æœ‰å®žé™…æ•°å€¼
- **ç¨³å®š**: å†…å­˜ç®¡ç†ä¼˜åŒ–
- **å…¨é¢**: æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸æ˜¾ç¤º
- **å¯è§£é‡Š**: æŒ‡æ ‡æ„ä¹‰æ˜Žç¡®

è¿™ä¸ºæ¨¡åž‹çš„ç”Ÿç‰©å­¦æœ‰æ•ˆæ€§è¯„ä¼°æä¾›äº†åšå®žåŸºç¡€ï¼ðŸ§¬